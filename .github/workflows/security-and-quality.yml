name: Quick Security Scan
on: [push, pull_request]
jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18 }
      - run: cd web-app && npm ci && npm run lint || true
      - uses: actions/setup-python@v4
        with: { python-version: "3.11" }
      - run: |
          pip install ruff black
          ruff check . || true
          black --check . || true
  trivy-fs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          format: table
          exit-code: '0'  # Don't fail on vulnerabilities, just report them
          severity: 'HIGH,CRITICAL'
  trivy-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          docker build -t api:ci -f api/Dockerfile api || echo "API Dockerfile not found, skipping"
          docker build -t web:ci -f web-app/Dockerfile web-app || echo "Web Dockerfile not found, skipping"
      - name: Scan API image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          image-ref: 'api:ci'
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities, just report them
          severity: 'HIGH,CRITICAL'
      - name: Scan Web image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          image-ref: 'web:ci'
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities, just report them
          severity: 'HIGH,CRITICAL'