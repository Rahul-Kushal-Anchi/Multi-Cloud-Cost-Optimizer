# CUR and Athena Terraform Module

This Terraform module provisions all AWS resources needed to set up Cost and Usage Reports (CUR) with Athena integration for the Cost Optimizer application.

## üìã What This Module Creates

- **S3 Bucket** for CUR reports (with versioning and encryption)
- **AWS Cost and Usage Report (CUR)** definition (Parquet format, daily delivery)
- **Glue Database** for organizing CUR data
- **Athena Workgroup** for querying CUR data
- **S3 Bucket** for Athena query results (with optional lifecycle policy)

## üîë Prerequisites

1. **AWS Account** with billing data access
2. **Terraform** >= 1.5.0 installed
3. **AWS CLI** configured with appropriate permissions
4. **IAM Permissions** required:
   - `s3:CreateBucket`, `s3:PutBucketPolicy`, `s3:PutBucketVersioning`, `s3:PutEncryptionConfiguration`
   - `cur:PutReportDefinition`, `cur:DescribeReportDefinitions`
   - `glue:CreateDatabase`, `glue:GetDatabase`
   - `athena:CreateWorkGroup`, `athena:GetWorkGroup`
   - `iam:CreateServiceLinkedRole` (if not already created for CUR)

## üöÄ Quick Start

### 1. Initialize Terraform

```bash
cd infra/cur-athena
terraform init
```

### 2. Review and Customize Variables (Optional)

```bash
# View available variables
terraform variables

# Create terraform.tfvars to override defaults
cat > terraform.tfvars << EOF
region                  = "us-east-1"
cur_bucket_prefix       = "my-company-cur-"
cur_report_name         = "my-company-cost-report"
athena_database_name    = "aws_billing"
athena_workgroup_name   = "primary"
EOF
```

### 3. Plan the Deployment

```bash
terraform plan
```

### 4. Apply the Configuration

```bash
terraform apply
```

Type `yes` when prompted to create the resources.

### 5. Get Connection Values

After Terraform completes, get the values needed for your Cost Optimizer app:

```bash
# View all outputs
terraform output

# Get connection values in JSON format
terraform output -json connection_values
```

## ‚ö†Ô∏è Important Notes

### CUR Delivery Time

**The first CUR report takes approximately 24 hours to be delivered after creation.**

- AWS billing data is processed and delivered daily
- You cannot query Athena until the first report is delivered
- The Glue table is automatically created by AWS when the first report arrives

### Finding the Actual Table Name

The Athena table name is auto-generated by AWS when the first CUR is delivered. To find it:

```bash
# Using AWS CLI
aws glue get-tables \
  --database-name $(terraform output -raw athena_database) \
  --query 'TableList[*].Name' \
  --output table

# Common table name format:
# cost_and_usage_report_YYYYMMDD
# or the report name you specified
```

Or check in the AWS Glue Console:
1. Go to AWS Glue Console ‚Üí Databases
2. Click on your database
3. View the tables list

### After First CUR Delivery

Once the first report is delivered:

1. **Verify the table exists:**
   ```bash
   aws glue get-tables --database-name aws_billing
   ```

2. **Test a query in Athena Console:**
   ```sql
   SELECT 
     date_trunc('day', from_iso8601_timestamp(line_item_usage_start_date)) AS day,
     SUM(COALESCE(CAST(line_item_unblended_cost AS double), 0)) AS cost
   FROM aws_billing.your_table_name
   WHERE from_iso8601_timestamp(line_item_usage_start_date) >= date_add('day', -7, current_timestamp)
   GROUP BY 1
   ORDER BY 1 ASC
   LIMIT 10;
   ```

3. **Update your connection values** with the actual table name

4. **Connect to Cost Optimizer app** using `./connect_and_test_aws.sh`

## üìä Connecting to Cost Optimizer App

After Terraform completes and you have the table name, you need:

1. **Role ARN** - Deploy the CloudFormation stack from `cfn/connect-aws-billing.yml` (or use existing role)
2. **External ID** - Generate one (see setup guide)
3. **Terraform outputs** - Use the `connection_values` output

Then run:

```bash
./connect_and_test_aws.sh
```

Or manually connect via the app UI with these values from `terraform output connection_values`.

## üîç Troubleshooting

### "CUR report not found" or "No reports delivered"

- Wait 24 hours after creation
- Check CUR status in AWS Billing Console
- Verify bucket policy allows CUR service to write
- Check CloudWatch Logs for CUR delivery errors

### "Table not found" in Athena

- Verify first CUR report has been delivered
- Check Glue Console for the table
- Ensure database name matches
- Table is created automatically, you cannot create it manually

### "Access Denied" when querying Athena

- Verify Athena workgroup permissions
- Check S3 bucket policies for Athena results bucket
- Ensure your IAM user/role has `athena:StartQueryExecution` permissions

### "Bucket already exists"

- S3 bucket names are globally unique
- Use `cur_bucket_prefix` variable to change the prefix
- Or manually specify a unique bucket name in variables

## üìù Outputs Reference

| Output | Description |
|--------|-------------|
| `cur_bucket` | S3 bucket name for CUR reports |
| `cur_prefix` | S3 prefix for CUR reports |
| `cur_report_name` | Name of the CUR report |
| `athena_database` | Athena/Glue database name |
| `athena_table` | Estimated table name (check after first delivery) |
| `athena_workgroup` | Athena workgroup name |
| `athena_results_bucket` | S3 bucket for Athena query results |
| `athena_results_prefix` | S3 prefix for Athena results |
| `region` | AWS region |
| `connection_values` | All values needed for app connection (JSON) |

## üóëÔ∏è Cleanup

To destroy all resources:

```bash
terraform destroy
```

**Warning:** This will delete:
- All CUR reports in the S3 bucket
- Athena query results
- The CUR report definition (reports will stop being delivered)

Make sure you have backups if needed!

## üìö Additional Resources

- [AWS Cost and Usage Reports Documentation](https://docs.aws.amazon.com/cur/latest/userguide/)
- [Amazon Athena Documentation](https://docs.aws.amazon.com/athena/)
- [AWS Glue Documentation](https://docs.aws.amazon.com/glue/)

## üîó Next Steps

After this module is deployed:

1. Wait for first CUR delivery (~24 hours)
2. Deploy CloudFormation stack for cross-account role (if needed)
3. Connect to Cost Optimizer app
4. Query live cost data via `/api/costs?days=7`

